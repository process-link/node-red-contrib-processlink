<script type="text/javascript">
  RED.nodes.registerType("processlink-config", {
    category: "config",
    defaults: {
      name: { value: "" },
      siteId: { value: "", required: false },
      apiKeyPrefix: { value: "" },
    },
    credentials: {
      apiKey: { type: "password" },
    },
    label: function () {
      return this.name || "Process Link Config";
    },
    oneditprepare: function () {
      var node = this;
      var apiKeyInput = $("#node-config-input-apiKey");
      var prefixHint = $("#apikey-prefix-hint");

      // Show existing prefix if we have one
      if (node.apiKeyPrefix) {
        prefixHint.text("Current key: " + node.apiKeyPrefix + "...").show();
      }

      // When API key changes, capture the prefix
      apiKeyInput.on("change keyup", function () {
        var val = apiKeyInput.val();
        // Only update if it's a new key (not the masked placeholder)
        if (val && val.length >= 8 && !val.startsWith("__PWRD__")) {
          node.apiKeyPrefix = val.substring(0, 8);
          prefixHint.text("Key prefix: " + node.apiKeyPrefix + "...").show();
        }
      });
    },
  });
</script>

<script type="text/html" data-template-name="processlink-config">
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-config-input-name" placeholder="My Site Config" />
  </div>
  <div class="form-row">
    <label for="node-config-input-siteId"><i class="fa fa-building"></i> Site ID</label>
    <input
      type="text"
      id="node-config-input-siteId"
      placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    />
  </div>
  <div class="form-row">
    <label for="node-config-input-apiKey"><i class="fa fa-key"></i> API Key</label>
    <input type="password" id="node-config-input-apiKey" placeholder="Your API key" />
    <span id="apikey-prefix-hint" style="display:none; margin-left: 105px; color: #888; font-size: 12px;"></span>
  </div>
  <div class="form-tips">
    <p>
      Get your API Key from the
      <a href="https://portal.processlink.com.au" target="_blank">Process Link Portal</a>
      under <strong>Developer &rarr; API Keys</strong>.
    </p>
    <p>
      <strong>Site ID</strong> is required for Files and ShiftLink nodes.
      Leave it blank if you only need ProcessMail (email sending).
    </p>
  </div>
</script>

<script type="text/html" data-help-name="processlink-config">
  <p>Configuration node for Process Link API authentication.</p>

  <h3>Properties</h3>
  <dl class="message-properties">
    <dt>Name <span class="property-type">string</span></dt>
    <dd>Optional friendly name for this configuration.</dd>
    <dt>Site ID <span class="property-type">string</span></dt>
    <dd>The UUID of your site from Process Link. Required for Files Upload and ShiftLink nodes. Optional for ProcessMail nodes.</dd>
    <dt>API Key <span class="property-type">string</span></dt>
    <dd>
      The API key for authentication. Generate one from Developer &rarr; API Keys in the Process Link Portal.
    </dd>
  </dl>

  <h3>Details</h3>
  <p>
    This configuration is shared across Process Link nodes in your flow. The API key is stored
    encrypted by Node-RED.
  </p>
  <p>
    <strong>Recommended setup:</strong> Use two config nodes &mdash; one with a site-scoped key (for Files/ShiftLink)
    and one with an org-wide key (for ProcessMail).
  </p>
</script>
