<script type="text/javascript">
  RED.nodes.registerType("processlink-mail", {
    category: "Process Link",
    color: "#f97316",
    defaults: {
      name: { value: "" },
      server: { value: "", type: "processlink-config", required: true },
      to: { value: "" },
      subject: { value: "" },
      body: { value: "" },
      bodyType: { value: "text" },
      cc: { value: "" },
      bcc: { value: "" },
      replyTo: { value: "" },
      useTemplate: { value: true },
      linkOnly: { value: false },
      timeout: { value: "30000", validate: function(v) { return !v || /^\d+$/.test(v); } },
    },
    inputs: 1,
    outputs: 2,
    icon: "processlink.png",
    paletteLabel: "send email",
    label: function () {
      return this.name || "send email";
    },
    labelStyle: function () {
      return this.name ? "node_label_italic" : "";
    },
    inputLabels: "email data",
    outputLabels: ["success", "error"],
  });
</script>

<script type="text/html" data-template-name="processlink-mail">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="fa fa-server"></i> Config</label>
    <input type="text" id="node-input-server" />
  </div>
  <div class="form-row">
    <label for="node-input-to"><i class="fa fa-envelope"></i> To</label>
    <input type="text" id="node-input-to" placeholder="msg.to (or default recipient)" />
  </div>
  <div class="form-row">
    <label for="node-input-subject"><i class="fa fa-header"></i> Subject</label>
    <input type="text" id="node-input-subject" placeholder="msg.subject" />
  </div>
  <div class="form-row">
    <label for="node-input-body"><i class="fa fa-file-text-o"></i> Body</label>
    <input type="text" id="node-input-body" placeholder="msg.body (optional - has default)" />
  </div>
  <div class="form-row">
    <label for="node-input-bodyType"><i class="fa fa-code"></i> Body Type</label>
    <select id="node-input-bodyType">
      <option value="text">Plain Text</option>
      <option value="html">HTML</option>
    </select>
  </div>
  <div class="form-row">
    <label for="node-input-cc"><i class="fa fa-envelope-o"></i> CC</label>
    <input type="text" id="node-input-cc" placeholder="msg.cc (optional)" />
  </div>
  <div class="form-row">
    <label for="node-input-bcc"><i class="fa fa-envelope-o"></i> BCC</label>
    <input type="text" id="node-input-bcc" placeholder="msg.bcc (optional)" />
  </div>
  <div class="form-row">
    <label for="node-input-replyTo"><i class="fa fa-reply"></i> Reply-To</label>
    <input type="text" id="node-input-replyTo" placeholder="msg.replyTo (optional)" />
  </div>
  <div class="form-row">
    <label for="node-input-useTemplate">&nbsp;</label>
    <input type="checkbox" id="node-input-useTemplate" style="width: auto; margin-right: 10px;">
    <span>Use branded email template</span>
  </div>
  <div class="form-row">
    <label for="node-input-linkOnly">&nbsp;</label>
    <input type="checkbox" id="node-input-linkOnly" style="width: auto; margin-right: 10px;">
    <span>Link only (don't attach files)</span>
  </div>
  <div class="form-row">
    <label for="node-input-timeout"><i class="fa fa-clock-o"></i> Timeout</label>
    <input type="text" id="node-input-timeout" placeholder="30000" />
    <span style="margin-left: 5px; color: #888">ms</span>
  </div>
</script>

<script type="text/html" data-help-name="processlink-mail">
  <p>Sends emails via the ProcessMail API.</p>

  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>to <span class="property-type">string | string[]</span></dt>
    <dd>Recipient email address(es). Can be set in config or via <code>msg.to</code>.</dd>

    <dt>subject <span class="property-type">string</span></dt>
    <dd>Email subject. Can be set in config or via <code>msg.subject</code>.</dd>

    <dt>body <span class="property-type">string</span></dt>
    <dd>Email body content via <code>msg.body</code>. Defaults to a notification message if not provided.</dd>

    <dt class="optional">bodyType <span class="property-type">string</span></dt>
    <dd>"text" (default) or "html". Can be set in config or via <code>msg.bodyType</code>.</dd>

    <dt class="optional">cc <span class="property-type">string | string[]</span></dt>
    <dd>CC recipients. Via config or <code>msg.cc</code>.</dd>

    <dt class="optional">bcc <span class="property-type">string | string[]</span></dt>
    <dd>BCC recipients. Via config or <code>msg.bcc</code>.</dd>

    <dt class="optional">replyTo <span class="property-type">string</span></dt>
    <dd>Reply-To address. Via config or <code>msg.replyTo</code>.</dd>

    <dt class="optional">file_id <span class="property-type">string</span></dt>
    <dd>Single file attachment from the upload node. Automatically converted to attachment.</dd>

    <dt class="optional">attachments <span class="property-type">array</span></dt>
    <dd>Multiple file attachments. Format: <code>[{ fileId: "uuid" }]</code>. Takes priority over <code>file_id</code>.</dd>

    <dt class="optional">linkOnly <span class="property-type">boolean</span></dt>
    <dd>When <code>true</code>, files are not attached - only links are included. Useful for large files.</dd>
  </dl>

  <h3>Outputs</h3>
  <p>This node has two outputs:</p>
  <ol>
    <li><strong>Success</strong> - Email sent successfully (HTTP 200)</li>
    <li><strong>Error</strong> - Email failed to send (network error, API error, or timeout)</li>
  </ol>

  <h4>Success Output</h4>
  <dl class="message-properties">
    <dt>payload.ok <span class="property-type">boolean</span></dt>
    <dd><code>true</code></dd>
    <dt>payload.email_id <span class="property-type">string</span></dt>
    <dd>ProcessMail log ID.</dd>
    <dt>payload.resend_id <span class="property-type">string</span></dt>
    <dd>Resend API ID for tracking.</dd>
    <dt>email_id <span class="property-type">string</span></dt>
    <dd>Same as above (convenience property).</dd>
    <dt>statusCode <span class="property-type">number</span></dt>
    <dd>200</dd>
  </dl>

  <h4>Error Output</h4>
  <dl class="message-properties">
    <dt>payload.error <span class="property-type">string</span></dt>
    <dd>Error message from the API or network layer.</dd>
    <dt>payload.code <span class="property-type">string</span></dt>
    <dd>Error code: MISSING_FIELDS, RATE_LIMIT_EXCEEDED, SEND_FAILED, etc.</dd>
    <dt>statusCode <span class="property-type">number</span></dt>
    <dd>HTTP status code, or 0 for network/timeout errors.</dd>
  </dl>

  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>To / Subject / Body</dt>
    <dd>Set default values here, or leave blank to use message properties.
    Config values take priority over <code>msg</code> properties. Body has a default if not set.</dd>
    <dt>Body Type</dt>
    <dd>Select "Plain Text" or "HTML" format.</dd>
    <dt>CC / BCC / Reply-To</dt>
    <dd>Optional. Can be set in config or via message properties.</dd>
    <dt>Use branded email template</dt>
    <dd>When enabled (default), wraps emails in a professional template with your organization name,
    ProcessLink branding, and clickable links to any attached files. Disable for raw email content.</dd>
    <dt>Link only (don't attach files)</dt>
    <dd>When enabled, files are not attached to the email. Instead, only links to the files
    are included in the email body/template. Useful for large files that would exceed email size limits.
    Can also be set via <code>msg.linkOnly</code>.</dd>
    <dt>Timeout</dt>
    <dd>Request timeout in ms. Default: 30000.</dd>
  </dl>

  <h3>File Attachments</h3>
  <p>To send emails with file attachments, first upload the file using the
  <code>processlink-files-upload</code> node, then connect it to this node.</p>

  <h4>Single Attachment (Direct Connection)</h4>
  <p>For a single file, simply connect the upload node directly to the mail node:</p>
  <pre>[file-in] → [upload] → [send email]</pre>
  <p>The mail node automatically uses <code>msg.file_id</code> from the upload node.</p>

  <h4>Multiple Attachments</h4>
  <p>For multiple files, use a function node to collect the file IDs:</p>
  <pre>[file-in] → [upload] → [function] → [send email]</pre>
  <pre>// Collect file IDs using flow context
let files = flow.get("uploadedFiles") || [];
files.push({ fileId: msg.file_id });
flow.set("uploadedFiles", files);

// When ready to send:
msg.attachments = flow.get("uploadedFiles");
flow.set("uploadedFiles", []); // Clear for next run
return msg;</pre>

  <h4>Link Only (Large Files)</h4>
  <p>For large files that would exceed email size limits, enable "Link only" in the config
  or set <code>msg.linkOnly = true</code>. The email will include clickable links to the files
  instead of attaching them directly.</p>
  <pre>// Send link instead of attachment for large files
msg.linkOnly = true;
return msg;</pre>

  <h3>Examples</h3>
  <h4>Simple Text Email</h4>
  <pre>msg.to = "user@example.com";
msg.subject = "Alert: System Down";
msg.body = "The production line has stopped.";
return msg;</pre>

  <h4>HTML Email</h4>
  <pre>msg.to = ["manager@example.com", "ops@example.com"];
msg.subject = "Daily Report";
msg.body = "&lt;h1&gt;Report&lt;/h1&gt;&lt;p&gt;All systems normal.&lt;/p&gt;";
msg.bodyType = "html";
return msg;</pre>

  <h3>Status Codes</h3>
  <ul>
    <li><strong>200</strong> - Email sent successfully</li>
    <li><strong>400</strong> - Bad request (missing fields, too many attachments)</li>
    <li><strong>401</strong> - Invalid API key</li>
    <li><strong>403</strong> - Service not enabled or missing scope</li>
    <li><strong>429</strong> - Daily email limit reached</li>
    <li><strong>500</strong> - Server error</li>
  </ul>

  <h3>References</h3>
  <ul>
    <li><a href="https://portal.processlink.com.au" target="_blank">Process Link Portal</a></li>
    <li><a href="https://github.com/process-link/node-red-contrib-processlink" target="_blank">GitHub</a></li>
  </ul>
</script>
