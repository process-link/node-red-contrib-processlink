<script type="text/javascript">
  RED.nodes.registerType("processlink-files-upload", {
    category: "Process Link",
    color: "#f97316",
    defaults: {
      name: { value: "" },
      server: { value: "", type: "processlink-config", required: true },
      filename: { value: "" },
      areaId: { value: "" },
      folderId: { value: "" },
      timestampPrefix: { value: false },
      timeout: { value: "30000" },
      apiUrl: { value: "https://files.processlink.com.au/api/upload" },
    },
    inputs: 1,
    outputs: 2,
    icon: "processlink.png",
    paletteLabel: "files upload",
    label: function () {
      return this.name || "files upload";
    },
    labelStyle: function () {
      return this.name ? "node_label_italic" : "";
    },
    inputLabels: "file buffer",
    outputLabels: ["success", "error"],
    oneditprepare: function () {
      var node = this;
      var $location = $("#node-input-location");
      var $areaId = $("#node-input-areaId");
      var $folderId = $("#node-input-folderId");
      var $server = $("#node-input-server");

      function loadLocations() {
        var configId = $server.val();
        if (!configId) {
          $location.html('<option value="">-- Select config first --</option>');
          return;
        }

        var configNode = RED.nodes.node(configId);
        if (!configNode || !configNode.siteId) {
          $location.html('<option value="">-- Config not ready --</option>');
          return;
        }

        $location.html('<option value="">Loading...</option>');

        // Fetch locations via server-side endpoint (credentials are not accessible client-side)
        $.ajax({
          url: "processlink/locations/" + configId,
          method: "GET",
        }).done(function (result) {
          var areas = result.areas || [];
          var folders = result.folders || [];

          // Build current selection key for matching
          var currentAreaId = node.areaId || "";
          var currentFolderId = node.folderId || "";
          var currentKey = currentAreaId + "|" + currentFolderId;

          var options = '<option value="|" data-area="" data-folder="">Site root (default)</option>';

          // Group folders by area
          var foldersByArea = {};
          folders.forEach(function (f) {
            var areaKey = f.area_id || "";
            if (!foldersByArea[areaKey]) foldersByArea[areaKey] = [];
            foldersByArea[areaKey].push(f);
          });

          // Add areas with their folders
          areas.forEach(function (area) {
            var areaFolders = foldersByArea[area.id] || [];
            options += '<optgroup label="' + area.area_name + '">';

            // Area root option
            var areaRootKey = area.id + "|";
            var areaRootSelected = areaRootKey === currentKey ? ' selected' : '';
            options += '<option value="' + areaRootKey + '" data-area="' + area.id + '" data-folder=""' + areaRootSelected + '>' + area.area_name + ' (root)</option>';

            // Root folders in this area
            var rootFolders = areaFolders.filter(function (f) { return !f.parent_id; });
            rootFolders.sort(function (a, b) { return a.name.localeCompare(b.name); });

            rootFolders.forEach(function (folder) {
              var folderKey = area.id + "|" + folder.id;
              var selected = folderKey === currentKey ? ' selected' : '';
              options += '<option value="' + folderKey + '" data-area="' + area.id + '" data-folder="' + folder.id + '"' + selected + '>&nbsp;&nbsp;' + folder.name + '</option>';

              // Child folders
              var children = areaFolders.filter(function (c) { return c.parent_id === folder.id; });
              children.sort(function (a, b) { return a.name.localeCompare(b.name); });
              children.forEach(function (child) {
                var childKey = area.id + "|" + child.id;
                var childSelected = childKey === currentKey ? ' selected' : '';
                options += '<option value="' + childKey + '" data-area="' + area.id + '" data-folder="' + child.id + '"' + childSelected + '>&nbsp;&nbsp;&nbsp;&nbsp;' + child.name + '</option>';
              });
            });

            options += '</optgroup>';
          });

          // Add folders without an area
          var noAreaFolders = foldersByArea[""] || [];
          if (noAreaFolders.length > 0) {
            options += '<optgroup label="No Area">';
            var rootFolders = noAreaFolders.filter(function (f) { return !f.parent_id; });
            rootFolders.sort(function (a, b) { return a.name.localeCompare(b.name); });

            rootFolders.forEach(function (folder) {
              var folderKey = "|" + folder.id;
              var selected = folderKey === currentKey ? ' selected' : '';
              options += '<option value="' + folderKey + '" data-area="" data-folder="' + folder.id + '"' + selected + '>' + folder.name + '</option>';

              var children = noAreaFolders.filter(function (c) { return c.parent_id === folder.id; });
              children.sort(function (a, b) { return a.name.localeCompare(b.name); });
              children.forEach(function (child) {
                var childKey = "|" + child.id;
                var childSelected = childKey === currentKey ? ' selected' : '';
                options += '<option value="' + childKey + '" data-area="" data-folder="' + child.id + '"' + childSelected + '>&nbsp;&nbsp;' + child.name + '</option>';
              });
            });
            options += '</optgroup>';
          }

          $location.html(options);
        }).fail(function (xhr) {
          console.error("Failed to load locations:", xhr.responseText);
          // Check if config needs to be deployed
          var errorMsg = "";
          try {
            var err = JSON.parse(xhr.responseText);
            if (err.error === "Config node not found") {
              errorMsg = "Deploy config first, then click Refresh";
            } else {
              errorMsg = err.error || "Failed to load";
            }
          } catch (e) {
            errorMsg = "Failed to load locations";
          }
          $location.html('<option value="|">Site root (default)</option><option disabled>-- ' + errorMsg + ' --</option>');
        });
      }

      // Update hidden inputs when selection changes
      $location.on("change", function () {
        var $selected = $location.find(":selected");
        $areaId.val($selected.data("area") || "");
        $folderId.val($selected.data("folder") || "");
      });

      // Load locations when config changes
      $server.on("change", function () {
        loadLocations();
      });

      // Refresh button
      $("#node-input-location-refresh").on("click", function () {
        loadLocations();
      });

      // Initial load
      loadLocations();
    },
  });
</script>

<script type="text/html" data-template-name="processlink-files-upload">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="fa fa-server"></i> Config</label>
    <input type="text" id="node-input-server" />
  </div>
  <div class="form-row">
    <label for="node-input-filename"><i class="fa fa-file"></i> Filename</label>
    <input type="text" id="node-input-filename" placeholder="msg.filename (or specify default)" />
  </div>
  <div class="form-row">
    <label for="node-input-location"><i class="fa fa-folder"></i> Location</label>
    <select id="node-input-location" style="width: 60%">
      <option value="|">Site root (default)</option>
    </select>
    <button type="button" id="node-input-location-refresh" class="red-ui-button" style="margin-left: 5px">
      <i class="fa fa-refresh"></i>
    </button>
    <input type="hidden" id="node-input-areaId" />
    <input type="hidden" id="node-input-folderId" />
  </div>
  <div class="form-row">
    <label for="node-input-timestampPrefix">&nbsp;</label>
    <input type="checkbox" id="node-input-timestampPrefix" style="width: auto; margin-right: 10px;">
    <span>Prefix filename with timestamp (YYYY-MM-DD_HH-mm-ss_)</span>
  </div>
  <div class="form-row">
    <label for="node-input-timeout"><i class="fa fa-clock-o"></i> Timeout</label>
    <input type="text" id="node-input-timeout" placeholder="30000" />
    <span style="margin-left: 5px; color: #888">ms</span>
  </div>
  <div class="form-row" style="display: none">
    <label for="node-input-apiUrl"><i class="fa fa-link"></i> API URL</label>
    <input type="text" id="node-input-apiUrl" />
  </div>
</script>

<script type="text/html" data-help-name="processlink-files-upload">
  <p>Uploads files to the Process Link Files API.</p>

  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">buffer | string</span></dt>
    <dd>The file content to upload.</dd>
    <dt class="optional">filename <span class="property-type">string</span></dt>
    <dd>Fallback filename if not set in config. Priority: config → <code>msg.filename</code> → "file.bin".</dd>
  </dl>

  <h3>Outputs</h3>
  <p>This node has two outputs:</p>
  <ol>
    <li><strong>Success</strong> - Upload completed successfully (HTTP 201)</li>
    <li><strong>Error</strong> - Upload failed (network error, API error, or timeout)</li>
  </ol>

  <h4>Success Output</h4>
  <dl class="message-properties">
    <dt>payload.ok <span class="property-type">boolean</span></dt>
    <dd><code>true</code></dd>
    <dt>payload.file_id <span class="property-type">string</span></dt>
    <dd>UUID of the uploaded file.</dd>
    <dt>file_id <span class="property-type">string</span></dt>
    <dd>Same as above (convenience property).</dd>
    <dt>statusCode <span class="property-type">number</span></dt>
    <dd>201</dd>
  </dl>

  <h4>Error Output</h4>
  <dl class="message-properties">
    <dt>payload.error <span class="property-type">string</span></dt>
    <dd>Error message from the API or network layer.</dd>
    <dt>statusCode <span class="property-type">number</span></dt>
    <dd>HTTP status code, or 0 for network/timeout errors.</dd>
  </dl>

  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>Filename <span class="property-type">string</span></dt>
    <dd>Filename for uploaded file. Takes priority over <code>msg.filename</code>.</dd>
    <dt>Location <span class="property-type">select</span></dt>
    <dd>Destination area/folder in the Files app. Default: site root.</dd>
    <dt>Prefix with timestamp <span class="property-type">boolean</span></dt>
    <dd>Adds <code>YYYY-MM-DD_HH-mm-ss_</code> prefix (ISO 8601). Applied regardless of filename source.</dd>
    <dt>Timeout <span class="property-type">number</span></dt>
    <dd>Request timeout in ms. Default: 30000.</dd>
  </dl>

  <h3>Status Codes</h3>
  <ul>
    <li><strong>201</strong> - Success</li>
    <li><strong>400</strong> - Bad request</li>
    <li><strong>401</strong> - Invalid API key</li>
    <li><strong>403</strong> - API access not enabled</li>
    <li><strong>404</strong> - Site not found</li>
    <li><strong>429</strong> - Rate limit exceeded</li>
    <li><strong>507</strong> - Storage limit exceeded</li>
  </ul>

  <h3>References</h3>
  <ul>
    <li><a href="https://portal.processlink.com.au" target="_blank">Process Link Portal</a></li>
    <li><a href="https://github.com/process-link/node-red-contrib-processlink" target="_blank">GitHub</a></li>
  </ul>
</script>
