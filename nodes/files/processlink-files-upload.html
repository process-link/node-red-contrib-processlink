<script type="text/javascript">
  RED.nodes.registerType("processlink-files-upload", {
    category: "Process Link",
    color: "#f97316",
    defaults: {
      name: { value: "" },
      server: { value: "", type: "processlink-config", required: true },
      filename: { value: "" },
      areaId: { value: "" },
      folderId: { value: "" },
      timestampPrefix: { value: false },
      timeout: { value: "30000", validate: function(v) { return !v || /^\d+$/.test(v); } },
    },
    inputs: 1,
    outputs: 2,
    icon: "processlink.png",
    paletteLabel: "files upload",
    label: function () {
      return this.name || "files upload";
    },
    labelStyle: function () {
      return this.name ? "node_label_italic" : "";
    },
    inputLabels: "file buffer",
    outputLabels: ["success", "error"],
    oneditprepare: function () {
      var node = this;
      var $location = $("#node-input-location");
      var $areaId = $("#node-input-areaId");
      var $folderId = $("#node-input-folderId");
      var $server = $("#node-input-server");

      function loadLocations() {
        var configId = $server.val();
        if (!configId) {
          $location.html('<option value="">-- Select config first --</option>');
          return;
        }

        var configNode = RED.nodes.node(configId);
        if (!configNode || !configNode.siteId) {
          $location.html('<option value="">-- Config not ready --</option>');
          return;
        }

        $location.html('<option value="">Loading...</option>');

        // Fetch locations via server-side endpoint (credentials are not accessible client-side)
        $.ajax({
          url: "processlink/locations/" + configId,
          method: "GET",
        }).done(function (result) {
          var areas = result.areas || [];
          var folders = result.folders || [];

          // Build current selection key for matching
          var currentAreaId = node.areaId || "";
          var currentFolderId = node.folderId || "";
          var currentKey = currentAreaId + "|" + currentFolderId;

          // Helper to create an <option> element safely (escapes text content)
          function makeOption(value, areaId, folderId, label, indent) {
            var $opt = $('<option>').val(value).attr('data-area', areaId || '').attr('data-folder', folderId || '');
            if (indent) $opt.html(indent + $('<span>').text(label).html());
            else $opt.text(label);
            if (value === currentKey) $opt.prop('selected', true);
            return $opt;
          }

          $location.empty();
          $location.append(makeOption('|', '', '', 'Site root (default)', ''));

          // Group folders by area
          var foldersByArea = {};
          folders.forEach(function (f) {
            var areaKey = f.area_id || "";
            if (!foldersByArea[areaKey]) foldersByArea[areaKey] = [];
            foldersByArea[areaKey].push(f);
          });

          // Helper to add folders to a container
          function addFolders(container, areaFolders, areaId) {
            var rootFolders = areaFolders.filter(function (f) { return !f.parent_id; });
            rootFolders.sort(function (a, b) { return a.name.localeCompare(b.name); });

            rootFolders.forEach(function (folder) {
              container.append(makeOption(areaId + '|' + folder.id, areaId, folder.id, folder.name, '&nbsp;&nbsp;'));

              // Child folders
              var children = areaFolders.filter(function (c) { return c.parent_id === folder.id; });
              children.sort(function (a, b) { return a.name.localeCompare(b.name); });
              children.forEach(function (child) {
                container.append(makeOption(areaId + '|' + child.id, areaId, child.id, child.name, '&nbsp;&nbsp;&nbsp;&nbsp;'));
              });
            });
          }

          // Add areas with their folders
          areas.forEach(function (area) {
            var areaFolders = foldersByArea[area.id] || [];
            var $group = $('<optgroup>').attr('label', area.area_name);

            // Area root option
            $group.append(makeOption(area.id + '|', area.id, '', area.area_name + ' (root)', ''));
            addFolders($group, areaFolders, area.id);

            $location.append($group);
          });

          // Add folders without an area
          var noAreaFolders = foldersByArea[""] || [];
          if (noAreaFolders.length > 0) {
            var $noAreaGroup = $('<optgroup>').attr('label', 'No Area');
            addFolders($noAreaGroup, noAreaFolders, '');
            $location.append($noAreaGroup);
          }
        }).fail(function (xhr) {
          console.error("Failed to load locations:", xhr.responseText);
          var errorMsg = "Failed to load locations";
          try {
            var err = JSON.parse(xhr.responseText);
            if (err.error === "Config node not found") {
              errorMsg = "Deploy config first, then click Refresh";
            } else if (err.error) {
              errorMsg = err.error;
            }
          } catch (e) {
            // keep default errorMsg
          }
          $location.empty();
          $location.append($('<option>').val('|').text('Site root (default)'));
          $location.append($('<option>').prop('disabled', true).text('-- ' + errorMsg + ' --'));
        });
      }

      // Update hidden inputs when selection changes
      $location.on("change", function () {
        var $selected = $location.find(":selected");
        $areaId.val($selected.data("area") || "");
        $folderId.val($selected.data("folder") || "");
      });

      // Load locations when config changes (clear stale values)
      $server.on("change", function () {
        $areaId.val("");
        $folderId.val("");
        loadLocations();
      });

      // Refresh button
      $("#node-input-location-refresh").on("click", function () {
        loadLocations();
      });

      // Initial load
      loadLocations();
    },
  });
</script>

<script type="text/html" data-template-name="processlink-files-upload">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="fa fa-server"></i> Config</label>
    <input type="text" id="node-input-server" />
  </div>
  <div class="form-row">
    <label for="node-input-filename"><i class="fa fa-file"></i> Filename</label>
    <input type="text" id="node-input-filename" placeholder="msg.filename (extension auto-added if missing)" />
  </div>
  <div class="form-row">
    <label for="node-input-location"><i class="fa fa-folder"></i> Location</label>
    <select id="node-input-location" style="width: 60%">
      <option value="|">Site root (default)</option>
    </select>
    <button type="button" id="node-input-location-refresh" class="red-ui-button" style="margin-left: 5px">
      <i class="fa fa-refresh"></i>
    </button>
    <input type="hidden" id="node-input-areaId" />
    <input type="hidden" id="node-input-folderId" />
  </div>
  <div class="form-row">
    <label for="node-input-timestampPrefix">&nbsp;</label>
    <input type="checkbox" id="node-input-timestampPrefix" style="width: auto; margin-right: 10px;">
    <span>Prefix filename with timestamp (YYYY-MM-DD_HH-mm-ss_)</span>
  </div>
  <div class="form-row">
    <label for="node-input-timeout"><i class="fa fa-clock-o"></i> Timeout</label>
    <input type="text" id="node-input-timeout" placeholder="30000" />
    <span style="margin-left: 5px; color: #888">ms</span>
  </div>
</script>

<script type="text/html" data-help-name="processlink-files-upload">
  <p>Uploads files to the Process Link Files API.</p>

  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">buffer | string</span></dt>
    <dd>The file content to upload.</dd>
    <dt class="optional">filename <span class="property-type">string</span></dt>
    <dd>Fallback filename if not set in config. Priority: config → <code>msg.filename</code> → "file.bin".</dd>
  </dl>

  <h3>Outputs</h3>
  <p>This node has two outputs:</p>
  <ol>
    <li><strong>Success</strong> - Upload completed successfully (HTTP 201)</li>
    <li><strong>Error</strong> - Upload failed (network error, API error, or timeout)</li>
  </ol>

  <h4>Success Output</h4>
  <dl class="message-properties">
    <dt>payload.ok <span class="property-type">boolean</span></dt>
    <dd><code>true</code></dd>
    <dt>payload.file_id <span class="property-type">string</span></dt>
    <dd>UUID of the uploaded file.</dd>
    <dt>file_id <span class="property-type">string</span></dt>
    <dd>Same as above (convenience property).</dd>
    <dt>statusCode <span class="property-type">number</span></dt>
    <dd>201</dd>
  </dl>

  <h4>Error Output</h4>
  <dl class="message-properties">
    <dt>payload.error <span class="property-type">string</span></dt>
    <dd>Error message from the API or network layer.</dd>
    <dt>statusCode <span class="property-type">number</span></dt>
    <dd>HTTP status code, or 0 for network/timeout errors.</dd>
  </dl>

  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>Filename <span class="property-type">string</span></dt>
    <dd>Filename for uploaded file. Takes priority over <code>msg.filename</code>.
    If no extension is provided (e.g., "report"), the extension from <code>msg.filename</code> is automatically appended (e.g., "report.pdf").</dd>
    <dt>Location <span class="property-type">select</span></dt>
    <dd>Destination area/folder in the Files app. Default: site root.</dd>
    <dt>Prefix with timestamp <span class="property-type">boolean</span></dt>
    <dd>Adds <code>YYYY-MM-DD_HH-mm-ss_</code> prefix (ISO 8601). Applied regardless of filename source.</dd>
    <dt>Timeout <span class="property-type">number</span></dt>
    <dd>Request timeout in ms. Default: 30000.</dd>
  </dl>

  <h3>Status Codes</h3>
  <ul>
    <li><strong>201</strong> - Success</li>
    <li><strong>400</strong> - Bad request</li>
    <li><strong>401</strong> - Invalid API key</li>
    <li><strong>403</strong> - API access not enabled</li>
    <li><strong>404</strong> - Site not found</li>
    <li><strong>429</strong> - Rate limit exceeded</li>
    <li><strong>507</strong> - Storage limit exceeded</li>
  </ul>

  <h3>References</h3>
  <ul>
    <li><a href="https://portal.processlink.com.au" target="_blank">Process Link Portal</a></li>
    <li><a href="https://github.com/process-link/node-red-contrib-processlink" target="_blank">GitHub</a></li>
  </ul>
</script>
